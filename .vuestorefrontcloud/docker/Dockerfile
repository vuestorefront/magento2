FROM node:16

ARG COMMIT
ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY
ARG MAGENTO_BASE_URL
ARG MAGENTO_GRAPHQL_URL
ARG MAGENTO_EXTERNAL_CHECKOUT_ENABLED
ARG MAGENTO_EXTERNAL_CHECKOUT_URL
ARG MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH
ARG STORE_URL
ARG IMAGE_PROVIDER
ARG IMAGE_PROVIDER_BASE_URL
ARG REDIS_ENABLED
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_KEY_PREFIX
ARG REDIS_CACHE_INVALIDATE_URL
ARG REDIS_CACHE_INVALIDATE_KEY
ARG RECAPTCHA_ENABLED
ARG RECAPTCHA_HIDE_BADGE
ARG RECAPTCHA_VERSION
ARG RECAPTCHA_SIZE
ARG RECAPTCHA_MIN_SCORE
ARG RECAPTCHA_SITE_KEY
ARG RECAPTCHA_SECRET_KEY
ARG SENTRY_DSN

ENV NUXT_APP_ENV=production
ENV NUXT_APP_PORT=3000

ENV MAGENTO_BASE_URL=${MAGENTO_BASE_URL}
ENV MAGENTO_GRAPHQL_URL=${MAGENTO_GRAPHQL_URL}
ENV MAGENTO_EXTERNAL_CHECKOUT_ENABLED=${MAGENTO_EXTERNAL_CHECKOUT_ENABLED}
ENV MAGENTO_EXTERNAL_CHECKOUT_URL=${MAGENTO_EXTERNAL_CHECKOUT_URL}
ENV MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH=${MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH}
ENV STORE_URL=${STORE_URL}
ENV LAST_COMMIT=${COMMIT}
ENV IMAGE_PROVIDER=${IMAGE_PROVIDER}
ENV IMAGE_PROVIDER_BASE_URL=${IMAGE_PROVIDER_BASE_URL}
ENV REDIS_ENABLED=${REDIS_ENABLED}
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT}
ENV REDIS_KEY_PREFIX=${REDIS_KEY_PREFIX}
ENV REDIS_CACHE_INVALIDATE_KEY=${REDIS_CACHE_INVALIDATE_KEY}
ENV REDIS_CACHE_INVALIDATE_URL=${REDIS_CACHE_INVALIDATE_URL}
ENV SENTRY_DSN=${SENTRY_DSN}
ENV RECAPTCHA_ENABLED=${RECAPTCHA_ENABLED}
ENV RECAPTCHA_HIDE_BADGE=${RECAPTCHA_HIDE_BADGE}
ENV RECAPTCHA_VERSION=${RECAPTCHA_VERSION}
ENV RECAPTCHA_SIZE=${RECAPTCHA_SIZE}
ENV RECAPTCHA_MIN_SCORE=${RECAPTCHA_MIN_SCORE}
ENV RECAPTCHA_SITE_KEY=${RECAPTCHA_SITE_KEY}
ENV RECAPTCHA_SECRET_KEY=${RECAPTCHA_SITE_KEY}

RUN npm config set @vsf-enterprise:registry=https://registrynpm.storefrontcloud.io

RUN npm install -g npm-cli-login \
  && npm-cli-login

WORKDIR /var/www

COPY . .

RUN mv /var/www/packages/theme/nuxt.config.js /var/www/packages/theme/base.nuxt.config.js && cp .vuestorefrontcloud/docker/nuxt.config.additional.js /var/www/packages/theme/nuxt.config.js

RUN yarn install

RUN npx yarn@1.19.0 workspace @vue-storefront/magento-theme add @sentry/tracing @nuxtjs/sentry

RUN yarn build && yarn cache clean --all
COPY .vuestorefrontcloud/docker/vue-storefront.sh /usr/local/bin/

RUN chmod a+x /usr/local/bin/vue-storefront.sh

ENTRYPOINT ["vue-storefront.sh"]
